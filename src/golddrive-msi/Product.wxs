<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product
        Id="*"
        Name="$(var.MyProductName) $(var.MyProductVersion)"
        Manufacturer="$(var.MyCompanyName)"
        Version="$(var.MyVersion)"
        Language="1033"
        UpgradeCode="39F33CFA-2562-4866-AE81-0A863342BE23">

        <Package
            Description="$(var.MyProductName) - $(var.MyDescription)"
            InstallerVersion="200" 
            Compressed="yes"
            InstallScope="perMachine" 
            Platform="x64"/>

        <MajorUpgrade
            Disallow="yes"
            AllowDowngrades="no"
            AllowSameVersionUpgrades="no"
            DisallowUpgradeErrorMessage="An older version of $(var.MyProductName) is already installed. You must uninstall it before you can install this version."
            DowngradeErrorMessage="A newer version of $(var.MyProductName) is already installed." />

        <Media Id="1" Cabinet="Golddrive.cab" EmbedCab="yes" />

        <Property Id="P.LauncherRegistryKey">Software\WOW6432Node\WinFsp\Services</Property>
        <Property Id="P.RegistryKey">Software\WinFsp</Property>
        
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLDIR" Name="Golddrive" />
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="GolddriveShortcut" Name="Golddrive" />
            </Directory>
        </Directory>
         
        <DirectoryRef Id="INSTALLDIR" FileSource="..\build\$(var.Configuration)">
            <Component Id="C.golddrive.exe">
                <File Name="golddrive.exe" KeyPath="yes" />
            </Component>
            <Component Id="C.golddrive.pdb">
                <File Name="golddrive.pdb" KeyPath="yes" />
            </Component>
            <Component Id="C.golddrive.reg" Guid="{3EF97966-E49E-4A0B-B68D-5EB2BDA61C21}">
                <RegistryKey
                    Root="HKLM"
                    Key="[P.LauncherRegistryKey]">
                    <RegistryKey
                        Key="golddrive">
                        <RegistryValue
                            Type="string"
                            Name="Executable"
                            Value="[INSTALLDIR]golddrive.exe"
                            KeyPath="yes" />
                        <RegistryValue
                            Type="string"
                            Name="CommandLine"
                            Value="%2 %1" />
                        <RegistryValue
                            Type="string"
                            Name="Security"
                            Value="D:P(A;;RPWPLC;;;WD)" />
                        <RegistryValue
                            Type="string"
                            Name="RunAs"
                            Value="." />
                        <RegistryValue
                            Type="integer"
                            Name="JobControl"
                            Value="1" />                        
                    </RegistryKey>
                </RegistryKey>
            </Component>
        </DirectoryRef>
        
        <Icon Id="logo.ico" SourceFile="..\golddrive-ui\golddrive.ico" />

        <DirectoryRef Id="INSTALLDIR" FileSource="..\golddrive-ui\bin\$(var.Configuration)">
            <Component Id="C.golddrive_ui.exe">
                <File Name="golddrive-ui.exe" KeyPath="yes">
                    <Shortcut Id="golddrive_ui_shortcut"
                              Name="Golddrive App"
                              Description="Open Golddrive App"
                              Directory="GolddriveShortcut"
                              WorkingDirectory="INSTALLDIR"
                              Advertise="yes"
                              Icon ="logo.ico" />
                </File>
                <RemoveFolder Id="DeleteShortcut" Directory="GolddriveShortcut" On="both" />
            </Component>            
            <Component Id="C.golddrive.ico">
                <File Name="golddrive.ico" KeyPath="yes" />
            </Component>            
            <Component Id="C.ControlzEx.dll">
                <File Name="ControlzEx.dll" KeyPath="yes" />
            </Component>            
            <Component Id="C.MahApps.Metro.dll">
                <File Name="MahApps.Metro.dll" KeyPath="yes" />
            </Component>            
            <Component Id="C.MaterialDesignColors.dll">
                <File Name="MaterialDesignColors.dll" KeyPath="yes" />
            </Component>            
            <Component Id="C.MaterialDesignThemes.Wpf.dll">
                <File Name="MaterialDesignThemes.Wpf.dll" KeyPath="yes" />
            </Component>            
            <Component Id="C.NLog.dll"><File Name="NLog.dll" KeyPath="yes" /></Component>            
            <Component Id="C.NLog.config"><File Name="NLog.config" KeyPath="yes" /></Component>            
            <Component Id="C.Renci.SshNet.dll"><File Name="Renci.SshNet.dll" KeyPath="yes" /></Component>            
            <Component Id="C.System.Windows.Interactivity.dll"><File Name="System.Windows.Interactivity.dll" KeyPath="yes" /></Component>            
        </DirectoryRef>

        <DirectoryRef Id="INSTALLDIR" FileSource="..\..\tools\openssh">
            <Component Id="C.ssh.exe"><File Name="ssh.exe" KeyPath="yes" /></Component>
            <Component Id="C.ssh_keygen.exe"><File Name="ssh-keygen.exe" KeyPath="yes" /></Component>
            <Component Id="C.sftp.exe"><File Name="sftp.exe" KeyPath="yes" /></Component>
            <Component Id="C.libcrypto.dll"><File Name="libcrypto.dll" KeyPath="yes" /></Component>
        </DirectoryRef>
        
        <ComponentGroup Id="C.Golddrive_cli">
            <ComponentRef Id="C.golddrive.exe" />
            <ComponentRef Id="C.golddrive.pdb" />
            <ComponentRef Id="C.golddrive.reg" />
        </ComponentGroup>
  
        <ComponentGroup Id="C.Golddrive_ui">
            <ComponentRef Id="C.golddrive_ui.exe" />
            <ComponentRef Id="C.golddrive.ico" />
            <ComponentRef Id="C.ControlzEx.dll" />
            <ComponentRef Id="C.MahApps.Metro.dll" />
            <ComponentRef Id="C.MaterialDesignColors.dll" />
            <ComponentRef Id="C.MaterialDesignThemes.Wpf.dll" />
            <ComponentRef Id="C.NLog.dll" />
            <ComponentRef Id="C.NLog.config" />
            <ComponentRef Id="C.Renci.SshNet.dll" />
            <ComponentRef Id="C.System.Windows.Interactivity.dll" />
        </ComponentGroup>
        
       <ComponentGroup Id="C.ssh">
            <ComponentRef Id="C.ssh.exe" />
            <ComponentRef Id="C.sftp.exe" />
            <ComponentRef Id="C.ssh_keygen.exe" />
            <ComponentRef Id="C.libcrypto.dll" />
        </ComponentGroup>

        <Feature
            Id="F.Main"
            Level="1"
            Title="$(var.MyProductName) $(var.MyProductVersion) core components"
            Description="Installs $(var.MyProductName) command line"
            Display="expand"
            AllowAdvertise="no"
            InstallDefault="local"
            Absent="disallow">
            <ComponentGroupRef Id="C.Golddrive_cli" />    
            <ComponentGroupRef Id="C.ssh" />
            <Feature
                Id="F.App"
                Level="1000"
                Title="$(var.MyProductName) App"
                Description="Installs the $(var.MyProductName) App to manage drives and setup ssh keys"
                AllowAdvertise="no"
                InstallDefault="local"
                Absent="allow">
                <ComponentGroupRef Id="C.Golddrive_ui" />
            </Feature>            
        </Feature>

        <UI Id="FeatureTree">
            <UIRef Id="WixUI_FeatureTree" />
            <!-- skip the license agreement dialog; higher Order takes priority (weird) -->
            <Publish
                Dialog="WelcomeDlg"
                Control="Next"
                Event="NewDialog"
                Value="CustomizeDlg"
                Order="10">NOT Installed</Publish>
            <Publish
                Dialog="CustomizeDlg"
                Control="Back"
                Event="NewDialog"
                Value="WelcomeDlg"
                Order="10">NOT Installed</Publish>
        </UI>
        
        <!--<UIRef Id="WixUI_FeatureTree"/>-->
        <!--<UI Id="WixUI_Minimal">
            <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
            <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
            <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />

            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
            <Property Id="WixUI_Mode" Value="Minimal" />

            <DialogRef Id="ErrorDlg" />
            <DialogRef Id="FatalError" />
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />
            <DialogRef Id="PrepareDlg" />
            <DialogRef Id="ProgressDlg" />
            <DialogRef Id="ResumeDlg" />
            <DialogRef Id="UserExit" />

            --><!-- This is the welcome dialog you specified--><!--
            <DialogRef Id="WelcomeDlg" />

            --><!-- Hook the new welcome dialog to the next one in the stack--><!--
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="PrepareDlg">1</Publish>

            <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>

            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>

            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>

            <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>

            <Property Id="ARPNOMODIFY" Value="1" />
        </UI>-->

        <!--<UIRef Id="WixUI_Common" />-->
 
    </Product>
</Wix>
